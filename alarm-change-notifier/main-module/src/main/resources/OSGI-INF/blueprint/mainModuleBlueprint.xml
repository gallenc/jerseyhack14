<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0">

  <!-- Generated Licence Authenticator Blueprint -->
  <!-- for productId='alarm-change-notifier/1.0-SNAPSHOT' -->

  <bean id="licenceAuthenticator" class="org.opennms.plugins.alarmnotifier.Temp" destroy-method="destroyMethod">
    <!-- <argument ref="licenceService" /> -->
  </bean>

  <bean id="pgDataSource" class="com.impossibl.postgres.jdbc.PGDataSource">
    <property name="host" value="localhost" />
    <property name="port" value="5432" />
    <property name="database" value="opennms" />
    <property name="user" value="opennms" />
    <property name="password" value="opennms" />
  </bean>

  <bean id="alarmNotifier" class="org.opennms.plugins.alarmnotifier.AlarmNotifier" init-method="init" destroy-method="destroy">
    <argument ref="pgDataSource" />

    <property name="connectionStatement" ref="connectionStatement" />
    <property name="disConnectionStatement" ref="disConnectionStatement" />
  </bean>

  <!-- This sql statement initialises the triggers in the database -->
  <!-- Note you must use /* */ for comments as string is rendered as single line. -->
  <bean id="connectionStatement" class="java.lang.String">
    <argument
      value="
CREATE OR REPLACE FUNCTION notify_event() RETURNS TRIGGER AS $$

    DECLARE 
        data json;
        notification json;
    
    BEGIN
    
/*
        -- Convert the old or new row to JSON, based on the kind of action.
        -- Action = DELETE?             -> OLD row
        -- Action = INSERT or UPDATE?   -> NEW row
*/
        IF (TG_OP = 'DELETE') THEN
            data = row_to_json(OLD);
        ELSE
            data = row_to_json(NEW);
        END IF;

/*        
        -- Contruct the notification as a JSON string. ( only in 9.4 not 9.2)
        --notification = json_build_object(
        --                  'table',TG_TABLE_NAME,
        --                  'action', TG_OP,
        --                  'data', data);
*/
       notification = data;
        
/*                        
        -- Execute pg_notify(channel, notification)
*/
        PERFORM pg_notify('dml_events',notification::text);
        
/*
        -- Result is ignored since this is an AFTER trigger
*/
        RETURN NULL; 
    END;
    
$$ LANGUAGE plpgsql;

 DROP TRIGGER IF EXISTS events_change_notify ON events;

 CREATE TRIGGER events_change_notify
 AFTER INSERT OR UPDATE OR DELETE ON events
    FOR EACH ROW EXECUTE PROCEDURE notify_event();
    
  " />
  </bean>

  <!-- This sql statement removes the triggers from the database -->
  <!-- Note you must use /* */ for comments as string is rendered as single line. -->
  <bean id="disConnectionStatement" class="java.lang.String">
    <argument value="
      DROP TRIGGER IF EXISTS events_change_notify ON events;
      
      DROP FUNCTION IF EXISTS notify_event();
  " />
  </bean>

</blueprint>
